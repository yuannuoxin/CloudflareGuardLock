name: 部署 Cloudflare Pages

on:
  workflow_dispatch:
    inputs:
      project_git_url:
        description: '需要部署的项目 Git 地址'
        required: true
        type: string
      project_branch:
        description: '项目分支（可选，默认为 main）'
        required: false
        type: string
        default: 'main'
      cf_account_id:
        description: 'Cloudflare Account ID'
        required: true
        type: string
      cf_api_token:
        description: 'Cloudflare API Token'
        required: true
        type: string
      cf_project_name:
        description: 'Cloudflare Pages 项目名称'
        required: true
        type: string

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: 检出 CGL 仓库
        uses: actions/checkout@v3
        with:
          path: cgl

      - name: 克隆目标项目
        run: |
          git clone ${{ inputs.project_git_url }} project
        working-directory: .

      - name: 创建部署目录
        run: |
          mkdir -p deployment
          cp -r project/* deployment/

      - name: 拷贝 CGL 函数到部署目录
        run: |
          mkdir -p deployment/functions
          cp -r cgl/functions/* deployment/functions/

      - name: 安装 Wrangler
        run: |
          npm install -g wrangler

      - name: 部署到 Cloudflare Pages
        run: |
          echo "正在部署到 Cloudflare Pages..."
          echo "项目名称: ${{ inputs.cf_project_name }}"
          echo "账户 ID: ${{ inputs.cf_account_id }}"
          echo "分支: ${{ inputs.project_branch }}"
          cd deployment
          echo "部署目录内容:"
          ls -la
          wrangler pages deploy . --project-name="${{ inputs.cf_project_name }}" --branch=${{ inputs.project_branch }}
        env:
          CLOUDFLARE_ACCOUNT_ID: ${{ inputs.cf_account_id }}
          CLOUDFLARE_API_TOKEN: ${{ inputs.cf_api_token }}